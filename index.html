<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>This Week at VUMC — Featured Events</title>

<style>
:root{
  --banner-bg:#3b556e;   /* grayish blue */
  --banner-fg:#ffffff;   /* white text */
  --accent-red:#c62828;  /* red header strip */
  --panel-bg:#ffffff;    /* white list background */
  --panel-fg:#000000;    /* black list text */
  --rule:#e5e7eb;        /* light divider */
  --scale: 1;            /* accessibility font scale (?scale=1.3) */
}

html,body{height:100%}
body{
  margin:0;
  background:transparent; /* lets ProPresenter background show */
  color:var(--panel-fg);
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  font-size: calc(16px * var(--scale));
}

.wrap{display:flex;flex-direction:column;width:100%;height:100%;box-sizing:border-box}

/* Top banner */
.bar{
  display:flex;align-items:center;justify-content:space-between;
  padding:.75rem 1.25rem;background:var(--banner-bg);color:var(--banner-fg)
}
.brand{font-weight:800;font-size:clamp(1.25rem,2.4vw,2.2rem);letter-spacing:.02em}
.clock{font-weight:800;font-variant-numeric:tabular-nums;font-size:clamp(1.05rem,2.0vw,1.6rem)}

/* Panel */
.panel{
  display:flex;flex-direction:column;background:var(--panel-bg);color:var(--panel-fg);
  border-left:1px solid var(--rule);border-right:1px solid var(--rule);border-bottom:1px solid var(--rule);
  height:100%;box-sizing:border-box
}
.panel-header{background:var(--accent-red);color:#fff;padding:.7rem 1.1rem;
  font-weight:900;font-size:clamp(1.1rem,2.2vw,1.6rem)}

/* Scroller */
.vwrap{position:relative;overflow:hidden;height:100%}
.vcontent{position:absolute;width:100%;animation:vscroll 480000ms linear infinite} /* 8 min */
@keyframes vscroll{0%{transform:translateY(0)}98%{transform:translateY(-50%)}100%{transform:translateY(0)}}

/* Items */
.day{padding:0.9rem 1.25rem 1rem;border-bottom:1px solid var(--rule)}
.dayhead{font-weight:900;opacity:.95;margin:0 0 .45rem;font-size:clamp(1.1rem,2.0vw,1.5rem)}
.event{padding:.5rem 0}
.title{font-size:clamp(1.1rem,2.1vw,1.6rem);line-height:1.4;font-weight:800}
.meta{opacity:.9;font-size:clamp(1rem,1.9vw,1.3rem);margin-top:.2rem;font-weight:600}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){ .vcontent{animation-duration:999999ms} }
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="brand">This Week at VUMC — Featured</div>
    <div class="clock" id="clock"></div>
  </div>

  <div class="panel">
    <div class="panel-header">Upcoming Featured Events</div>
    <div class="vwrap"><div class="vcontent" id="feed"></div></div>
  </div>
</div>

<script>
const TIMEZONE = 'America/New_York';      // Eastern (EST/EDT)
const DAYS_AHEAD = 60;                    // extra guard, though API already filters
const SRC = './featured.json';            // produced by GitHub Action

/* URL params: ?scale=1.4  ?speed=900000 (15 min loop) */
(function handleParams(){
  const p = new URLSearchParams(location.search);
  const scale = parseFloat(p.get('scale'));
  if (!isNaN(scale) && scale > 0) document.documentElement.style.setProperty('--scale', scale);
  const speed = parseInt(p.get('speed'), 10);
  if (!isNaN(speed) && speed > 0) {
    for (const sheet of document.styleSheets) {
      for (const r of sheet.cssRules) {
        if (r.selectorText === '.vcontent') { r.style.animationDuration = speed + 'ms'; return; }
      }
    }
  }
})();

/* Clock (EST) */
function tick(){
  const d=new Date();
  document.getElementById('clock').textContent = d.toLocaleString('en-US',{
    timeZone:TIMEZONE, weekday:'long', month:'long', day:'numeric',
    hour:'numeric', minute:'2-digit'
  });
}
setInterval(tick,1000); tick();

/* Load featured.json */
async function loadFeatured(){
  try{
    const res = await fetch(SRC, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const payload = await res.json();
    const events = (payload.events || [])
      .map(e => ({
        title: e.title || 'Untitled',
        start: e.start ? new Date(e.start) : null,
        end:   e.end   ? new Date(e.end)   : null,
        location: e.location || '',
        allDay: !!e.allDay
      }))
      // client-side guard window
      .filter(e => e.start && e.start <= new Date(Date.now()+DAYS_AHEAD*86400000))
      .sort((a,b)=> a.start - b.start);

    render(events);
  }catch(err){
    console.error(err);
    document.getElementById('feed').innerHTML =
      '<div class="day"><div class="dayhead">Unable to load featured.json</div><div class="event"><div class="meta">The Action may still be creating it. Try again shortly.</div></div></div>';
  }
}

/* Format (EST) */
function fmtDate(d){return d.toLocaleString('en-US',{timeZone:TIMEZONE,weekday:'short',month:'short',day:'numeric'});}
function fmtTime(d){return d.toLocaleString('en-US',{timeZone:TIMEZONE,hour:'numeric',minute:'2-digit'}).toLowerCase();}
function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* Group + render */
function render(events){
  const feed = document.getElementById('feed');
  if(!events.length){
    feed.innerHTML = '<div class="day"><div class="dayhead">No featured events</div></div>';
    return;
  }
  const byDay = {};
  for(const e of events){
    const label = fmtDate(e.start);
    (byDay[label]=byDay[label]||[]).push(e);
  }
  const labels = Object.keys(byDay).sort((a,b)=> new Date(a) - new Date(b));
  const html = labels.map(label=>{
    const rows = byDay[label].map(e=>{
      const when = e.allDay
        ? 'All day'
        : (!e.end || sameDay(e.start,e.end))
          ? `${fmtTime(e.start)}${e.end ? '–'+fmtTime(e.end) : ''}`
          : `${fmtDate(e.start)} ${fmtTime(e.start)} → ${fmtDate(e.end)} ${fmtTime(e.end)}`;
      return `<div class="event">
                <div class="title">${escapeHtml(e.title)}</div>
                <div class="meta">${escapeHtml(when)}${e.location ? ' • ' + escapeHtml(e.location) : ''}</div>
              </div>`;
    }).join('');
    return `<div class="day">
              <div class="dayhead">${escapeHtml(label)}</div>
              ${rows}
            </div>`;
  }).join('');
  feed.innerHTML = html + html; // duplicate for seamless loop
}

loadFeatured();
</script>
</body>
</html>
