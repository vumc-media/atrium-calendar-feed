<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>This Week at VUMC</title>

<style>
:root{
  --banner-bg:#3b556e;   /* grayish blue */
  --banner-fg:#ffffff;   /* white text */
  --accent-red:#c62828;  /* red header strip */
  --panel-bg:#ffffff;    /* white list background */
  --panel-fg:#000000;    /* black list text */
  --rule:#e5e7eb;        /* light divider */
}

/* page */
html,body{height:100%}
body{
  margin:0;
  background:transparent;             /* lets ProPresenter background show */
  color:var(--panel-fg);
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}

/* responsive container — fills whatever space PP gives this web cue */
.wrap{
  display:flex;
  flex-direction:column;
  width:100%;
  height:100%;
  box-sizing:border-box;
}

/* top banner (title + clock) */
.bar{
  display:flex; align-items:center; justify-content:space-between;
  padding:.6rem 1rem;
  background:var(--banner-bg);
  color:var(--banner-fg);
}
.brand{
  font-weight:800;
  font-size:clamp(1.1rem,2.2vw,2rem);
  letter-spacing:.02em;
}
.clock{
  font-weight:700;
  font-variant-numeric:tabular-nums;
  font-size:clamp(.95rem,1.8vw,1.4rem);
}

/* events panel */
.panel{
  display:flex; flex-direction:column;
  background:var(--panel-bg);
  color:var(--panel-fg);
  border-left:1px solid var(--rule);
  border-right:1px solid var(--rule);
  border-bottom:1px solid var(--rule);
  height:100%;
  box-sizing:border-box;
}

/* red strip title */
.panel-header{
  background:var(--accent-red);
  color:#fff;
  padding:.5rem .9rem;
  font-weight:800;
  font-size:clamp(1rem,2vw,1.4rem);
}

/* vertical scroller */
.vwrap{ position:relative; overflow:hidden; height:100%; }
.vcontent{
  position:absolute; width:100%;
  animation:vscroll 420000ms linear infinite; /* default 7 min */
}
@keyframes vscroll{
  0%{transform:translateY(0)}
  98%{transform:translateY(-50%)}   /* duplicate content for seamless loop */
  100%{transform:translateY(0)}
}

/* event list */
.day{ padding:.7rem 1rem .8rem; border-bottom:1px solid var(--rule); }
.dayhead{ font-weight:800; opacity:.9; margin:0 0 .35rem;
  font-size:clamp(.95rem,1.8vw,1.2rem); }
.event{ padding:.35rem 0; }
.title{ font-size:clamp(.95rem,1.9vw,1.25rem); line-height:1.35; }
.meta{ opacity:.85; font-size:clamp(.85rem,1.6vw,1.05rem); margin-top:.15rem; }
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="brand">This Week at VUMC</div>
    <div class="clock" id="clock"></div>
  </div>

  <div class="panel">
    <div class="panel-header">Upcoming Events</div>
    <div class="vwrap">
      <div class="vcontent" id="feed"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const ICS_URL = 'https://calendar.planningcenteronline.com/icals/eJxj4ajmsGLLz2Tu2cJoxZVanF9QUs1pxV6R5qmkYWZkZG6iAyJNwaQZmDQHkxZg0pLNis01xIqt2FOJPzEnJz61LDWvpJjNmgMoVprJ3HJT0oq9rMRTiQ8kWZKZmwqR4y5ILErMLa5mAAC_UiFG8e43188950d46674489ec120b9dc1c6feba180d6';
const TIMEZONE = 'America/New_York';  // Eastern (EST/EDT)
const DAYS_AHEAD = 45;

/* Optional: allow speed override via query param ?speed=600000 (ms) */
(function handleSpeedParam(){
  const params = new URLSearchParams(location.search);
  const ms = parseInt(params.get('speed'), 10);
  if (!isNaN(ms) && ms > 0) {
    const sheet = document.styleSheets[0];
    // Replace the animation duration in the first rule that contains vscroll
    for (const r of sheet.cssRules) {
      if (r.selectorText === '.vcontent') {
        r.style.animationDuration = ms + 'ms';
        break;
      }
    }
  }
})();

/* ====== CLOCK (force Eastern) ====== */
function tick(){
  const d = new Date();
  document.getElementById('clock').textContent = d.toLocaleString('en-US', {
    timeZone: TIMEZONE,
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit'
  });
}
setInterval(tick, 1000); tick();

/* ====== LOAD & PARSE ICS ====== */
async function loadICS(){
  try{
    const res = await fetch(ICS_URL, {cache:'no-store'});
    const txt = await res.text();
    const events = parseICS(txt);
    render(events);
  } catch(err){
    console.error(err);
    document.getElementById('feed').innerHTML =
      '<div class="day"><div class="dayhead">Unable to load calendar.</div></div>';
  }
}

/* Minimal iCal parser for VEVENT blocks */
function parseICS(ics){
  ics = ics.replace(/\r\n/g, '\n').replace(/\n[ \t]/g, '');
  const blocks = ics.split('BEGIN:VEVENT').slice(1).map(b => 'BEGIN:VEVENT' + b);
  const out = [];
  for (const block of blocks){
    const get = (name) => {
      const re = new RegExp('^' + name + '(?:;[^:\\n]+)?:([^\\n]+)', 'm');
      const m = block.match(re);
      return m ? m[1].trim() : '';
    };
    const unesc = (s) => String(s||'').replace(/\\n/g,'\n').replace(/\\,/g,',').replace(/\\\\/g,'\\');

    const s = get('DTSTART');
    const e = get('DTEND');
    const all = /^DTSTART;VALUE=DATE:/.test(block) || /^\d{8}$/.test(s);

    out.push({
      title: unesc(get('SUMMARY')) || 'Untitled',
      location: unesc(get('LOCATION')),
      allDay: all,
      start: parseIcsDate(s),
      end: parseIcsDate(e)
    });
  }

  const now = new Date();
  const until = new Date(now.getTime() + DAYS_AHEAD*86400000);
  return out
    .filter(ev => ev.start && ev.start >= now && ev.start <= until)
    .sort((a,b) => a.start - b.start);
}

function parseIcsDate(v){
  if (!v) return null;
  if (/^\d{8}$/.test(v)) {
    // All-day date (midnight UTC by convention)
    return new Date(Date.UTC(+v.slice(0,4), +v.slice(4,6)-1, +v.slice(6,8)));
  }
  if (/^\d{8}T\d{6}Z$/.test(v)) return new Date(v); // UTC timestamp
  if (/^\d{8}T\d{6}$/.test(v)) {
    // Local (no Z); construct as local time
    const y=+v.slice(0,4), m=+v.slice(4,6)-1, d=+v.slice(6,8),
          h=+v.slice(9,11), M=+v.slice(11,13), s=+v.slice(13,15)||0;
    return new Date(y,m,d,h,M,s);
  }
  return new Date(v);
}

/* ====== FORMAT (force Eastern) ====== */
function fmtDate(d){
  return d.toLocaleString('en-US', {
    timeZone: TIMEZONE,
    weekday: 'short',
    month: 'short',
    day: 'numeric'
  });
}
function fmtTime(d){
  return d.toLocaleString('en-US', {
    timeZone: TIMEZONE,
    hour: 'numeric',
    minute: '2-digit'
  }).toLowerCase();
}
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}

/* ====== RENDER ====== */
function render(events){
  const feed = document.getElementById('feed');
  if (!events.length){
    feed.innerHTML = '<div class="day"><div class="dayhead">No events</div></div>';
    return;
  }

  const byDay = {};
  for (const e of events){
    const label = fmtDate(e.start);
    (byDay[label] = byDay[label] || []).push(e);
  }

  const labels = Object.keys(byDay).sort((a,b)=> new Date(a) - new Date(b));
  const html = labels.map(label=>{
    const rows = byDay[label].map(e=>{
      const when = e.allDay
        ? 'All day'
        : (!e.end || sameDay(e.start,e.end))
          ? `${fmtTime(e.start)}${e.end ? '–' + fmtTime(e.end) : ''}`
          : `${fmtDate(e.start)} ${fmtTime(e.start)} → ${fmtDate(e.end)} ${fmtTime(e.end)}`;
      return `<div class="event">
                <div class="title">${escapeHtml(e.title)}</div>
                <div class="meta">${escapeHtml(when)}${e.location ? ' • ' + escapeHtml(e.location) : ''}</div>
              </div>`;
    }).join('');
    return `<div class="day">
              <div class="dayhead">${escapeHtml(label)}</div>
              ${rows}
            </div>`;
  }).join('');

  // Duplicate for seamless scroll loop
  feed.innerHTML = html + html;
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

loadICS();
</script>
</body>
</html>
